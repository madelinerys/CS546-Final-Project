<h1>Admin</h1>

<article>
<h2>Set SimDate</h2>
<h3>Set the system date to sometime in the past, which will allow you to bet on games that have already occurred,
which in turn is needed for debugging and testing, along with conducting demos of the system</h3>

<form id="setSimDate" name="setSimDate" action="/admin/simdate">
<label for="simdate">SimDate</label>
<input name="simdate" id="simdate" type="date" value="{{simdate}}"/>
<button id="btnClearSimDate" name="btnClearSimDate">Clear SimDate</button>
</form>
</article>

<div class="vspacer"></div>

<article>
<h2>Delete all bets</h2>
<h3>Deletes all bets from bets collection, leaving it empty</h3>

<form id="deleteAllBets" name="deleteAllBets" action="/admin/bets">
<label for="idDeleteBets">Delete All Bets</label>
<button id="idDeleteBets" name="btnDeleteBets">Delete All Bets</button>
</form>
</article>

<div class="vspacer"></div>

<article>
<h2>Resolve all bets</h2>
<h3>Decides all bets (win/lose/push) based on either current date (today), or SimDate if it's non-null</h3>

<form name="resolveAllBets" action="/admin/resolveAllBets">
<label for="idResolveBets">Resolve All Bets</label>
<button id="idResolveBets" name="btnResolveBets">Resolve All Bets</button>
</form>
</article>

<div class="vspacer"></div>

<article>
<h2>Time out user</h2>
<h3>Invalidates AuthCookie, so next time the user tries to do something, they should kick out</h3>

<form name="timeOutUser" action="/admin/timeOutUser">
<label for="idTimeOut">Username</label>
<input name="timeOut" id="idTimeOut" type="text"/>
<button name="btnTimeOut">Time Out User</button>
</form>
</article>

<script>
let orgSimdate = "{{simdate}}";

$('#deleteAllBets').submit(deleteAllBets);
$('#simdate').change(simDateChanged);
$('#simdate').focus(simDateFocused);
$('#simdate').focus(simDateFocused);
$('#btnClearSimDate').click(clearSimDate);

function clearSimDate(ev) {
  ev.preventDefault();
  $("#simdate").val(null);
  simDateChanged(ev);
}

function simDateChanged(ev) {
  ev.preventDefault();
  const simdateControl = $("#simdate");
  const todayDate = new Date().toISOString().split("T")[0];
  const todayDateJulian = new Date(todayDate).valueOf();
 
  const simdate = simdateControl.val();
  const simDateJulian = new Date(simdate).valueOf();

  if (simDateJulian >= todayDateJulian) {
    alert("SimDate must be set to either a date in the past, or empty to disable.")
    simdateControl.val(orgSimdate);
    return;
  }
  var requestConfig = {
    method: 'PUT',
    data: {simdate: simdateControl.val()},
    url: '/admin/simdate',
  };
  $.ajax(requestConfig).then(function (responseMessage) {
    orgSimdate = simdateControl.val();
    console.log("orgSimdate is now " + orgSimdate);
    console.log(responseMessage);
  }).catch(console.log);
  console.log("org sim date is " + orgSimdate);
}

function simDateFocused(ev) {
  orgSimdate = $("#simdate").val();
}

function simDateReset(ev) {
  alert("simDateReset");
}

function deleteAllBets(ev) {
  ev.preventDefault();
  const b = confirm("Are you sure you want to delete all bets from the bets collection?");
  if (!b)
    return;
  var requestConfig = {
    method: 'DELETE',
    url: '/admin/bets',
  };
  $.ajax(requestConfig).then(function (responseMessage) {
    alert("You're the boss -- all bets have been deleted!");
  }).catch(e => alert("there was an error " + JSON.stringify(e) + "deleting all bets."));
}

</script>

